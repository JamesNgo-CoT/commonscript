{"version":3,"sources":["backbone/sync_factory.min.js"],"names":["syncFactory","sync","login","originatingElement","_this","this","method","model","options","arguments","length","undefined","deferred","$","Deferred","Promise","resolve","then","_","result","requireLogin","beforeSend","jqXHR","setRequestHeader","sid","contentType","error","status","errorThrown","errorMessageTemplate","template","alert","message","responseJSON","responseText","indexOf","showLogin","onHidden","checkLogin","trigger","logout","responseTextrThrown","call","apply","reject"],"mappings":"AAAA,aAGA,SAASA,YAAYC,EAAMC,EAAOC,GAChC,IAAIC,EAAQC,KAEZ,OAAO,SAAUC,EAAQC,GACvB,IAAIC,EAA6B,EAAnBC,UAAUC,aAA+BC,IAAjBF,UAAU,GAAmBA,UAAU,GAAK,GAE9EG,EAAWC,EAAEC,WAuEjB,OArEAC,QAAQC,UAAUC,KAAK,WACrB,GAAIf,IAAUgB,EAAEC,OAAOZ,EAAMA,MAAO,sBAAwBW,EAAEC,OAAOZ,EAAO,sBAC1E,OAAOL,EAAMkB,aAAa,CACxBjB,mBAAoBA,MAGvBc,KAAK,WACFf,IAAUgB,EAAEC,OAAOZ,EAAMA,MAAO,sBAAwBW,EAAEC,OAAOZ,EAAO,wBAC1EC,EAAQa,WAAa,SAAUC,GAC7BA,EAAMC,iBAAiB,gBAAiB,eAAiBrB,EAAMsB,OAInEhB,EAAQiB,YAAcjB,EAAQiB,aAAe,mBAE7CjB,EAAQkB,MAAQ,SAAUJ,EAAOK,EAAQC,GACvC,IAAIC,EAAuBX,EAAEY,SAAS,8DAClB,KAAhBR,EAAMK,QAAiBL,EAAMK,QAAU,IACzCI,MAAMF,EAAqB,CACzBF,OAAQL,EAAMK,OACdK,QAAS,2DAEe,MAAjBV,EAAMK,SAAmBL,EAAMW,cAAgBX,EAAMY,eAA8D,IAA9CZ,EAAMY,aAAaC,QAAQ,gBAAsE,IAA9Cb,EAAMY,aAAaC,QAAQ,cACxJjC,IAAUgB,EAAEC,OAAOZ,EAAMA,MAAO,sBAAwBW,EAAEC,OAAOZ,EAAO,sBAC1EL,EAAMkC,UAAU,CACdC,SAAU,WACRnC,EAAMoC,WAAW9B,GAASS,KAAK,WAC7BV,EAAMgC,QAAQ,iBACb,WACGrC,EAAMsB,KACRtB,EAAMsC,YAIZrC,mBAAoBA,IAGtB4B,MAAMF,EAAqB,CACzBF,OAAQL,EAAMK,OACdK,QAASV,EAAMY,gBAGO,MAAjBZ,EAAMK,SAENL,EAAMW,cAAgBX,EAAMW,aAAaP,OAASJ,EAAMW,aAAaP,MAAMM,QACpFD,MAAMF,EAAqB,CACzBF,OAAQL,EAAMK,OACdK,QAASV,EAAMW,aAAaP,MAAMM,WAE3BV,EAAMY,aACfH,MAAMF,EAAqB,CACzBF,OAAQL,EAAMK,OACdK,QAASV,EAAMmB,uBAGjBV,MAAMF,EAAqB,CACzBF,OAAQL,EAAMK,OACdK,QAASJ,OAKf3B,EAAKyC,KAAKtC,EAAOE,EAAQC,EAAOC,GAASS,KAAK,WAC5CL,EAASI,QAAQ2B,MAAM/B,EAAUH,YAChC,WACDG,EAASgC,OAAOD,MAAM/B,EAAUH,eAI7BG","file":"sync_factory.min.js","sourcesContent":["'use strict';\n\n/* exported syncFactory */\nfunction syncFactory(sync, login, originatingElement) {\n  var _this = this;\n\n  return function (method, model) {\n    var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\n    var deferred = $.Deferred();\n\n    Promise.resolve().then(function () {\n      if (login && (_.result(model.model, 'syncRequiresLogin') || _.result(model, 'syncRequiresLogin'))) {\n        return login.requireLogin({\n          originatingElement: originatingElement\n        });\n      }\n    }).then(function () {\n      if (login && (_.result(model.model, 'syncRequiresLogin') || _.result(model, 'syncRequiresLogin'))) {\n        options.beforeSend = function (jqXHR) {\n          jqXHR.setRequestHeader('Authorization', 'AuthSession ' + login.sid);\n        };\n      }\n\n      options.contentType = options.contentType || 'application/json';\n\n      options.error = function (jqXHR, status, errorThrown) {\n        var errorMessageTemplate = _.template('An error ocurred. Error code <%- status %>. <%= message %>');\n        if (jqXHR.status >= 500 && jqXHR.status <= 599) {\n          alert(errorMessageTemplate({\n            status: jqXHR.status,\n            message: 'Server side error. Please contact your administrator.'\n          }));\n        } else if (jqXHR.status === 400 && !jqXHR.responseJSON && jqXHR.responseText && jqXHR.responseText.indexOf('Session id') !== -1 && jqXHR.responseText.indexOf('is invalid') !== -1) {\n          if (login && (_.result(model.model, 'syncRequiresLogin') || _.result(model, 'syncRequiresLogin'))) {\n            login.showLogin({\n              onHidden: function onHidden() {\n                login.checkLogin(options).then(function () {\n                  model.trigger('reloadNeeded');\n                }, function () {\n                  if (login.sid) {\n                    login.logout();\n                  }\n                });\n              },\n              originatingElement: originatingElement\n            });\n          } else {\n            alert(errorMessageTemplate({\n              status: jqXHR.status,\n              message: jqXHR.responseText\n            }));\n          }\n        } else if (jqXHR.status === 404) {\n          // DO NOTHING - TODO - THINK MORE ABOUT SIDE EFFECTS\n        } else if (jqXHR.responseJSON && jqXHR.responseJSON.error && jqXHR.responseJSON.error.message) {\n          alert(errorMessageTemplate({\n            status: jqXHR.status,\n            message: jqXHR.responseJSON.error.message\n          }));\n        } else if (jqXHR.responseText) {\n          alert(errorMessageTemplate({\n            status: jqXHR.status,\n            message: jqXHR.responseTextrThrown\n          }));\n        } else {\n          alert(errorMessageTemplate({\n            status: jqXHR.status,\n            message: errorThrown\n          }));\n        }\n      };\n\n      sync.call(_this, method, model, options).then(function () {\n        deferred.resolve.apply(deferred, arguments);\n      }, function () {\n        deferred.reject.apply(deferred, arguments);\n      });\n    });\n\n    return deferred;\n  };\n}"]}