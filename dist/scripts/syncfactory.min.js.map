{"version":3,"sources":["scripts/syncfactory.min.js"],"names":["syncFactory","sync","cotLogin","_this","this","syncCounter","newSync","method","model","options","arguments","length","undefined","attempt","deferred","$","Deferred","Promise","resolve","then","_","result","requireLogin","originatingElement","$originatingElement","reject","jqXHR","setRequestHeader","sid","Backbone","trigger","call","data","textStatus","errorThrown","status","responseJSON","responseText","indexOf","showLogin","onHidden","checkLogin","logout","error","message","always"],"mappings":"AAAA,aAGA,SAASA,YAAYC,EAAMC,GAC1B,IAAIC,EAAQC,KAERC,EAAc,EA4ElB,OA3Ec,SAASC,EAAQC,EAAQC,GACtC,IAAIC,EAA6B,EAAnBC,UAAUC,aAA+BC,IAAjBF,UAAU,GAAmBA,UAAU,GAAK,GAC9EG,EAA6B,EAAnBH,UAAUC,aAA+BC,IAAjBF,UAAU,GAAmBA,UAAU,GAAK,EAE9EI,EAAWC,EAAEC,WAoEjB,OAlEAC,QAAQC,UAAUC,KAAK,WACtB,GAAIC,EAAEC,OAAOb,EAAO,kBACnB,OAAIN,EACIA,EAASoB,aAAa,CAC5BC,mBAAoBd,EAAQe,sBAGtBP,QAAQQ,WAGfN,KAAK,WACHC,EAAEC,OAAOb,EAAO,oBACnBC,EAAoB,WAAI,SAAUiB,GACjCA,EAAMC,iBAAiB,gBAAiB,eAAiBzB,EAAS0B,OAIpEnB,EAAqB,YAAIA,EAAqB,aAAK,mBAEnDJ,GAA4B,EAC5BwB,SAASC,QAAQ,OAAQ,KAAMzB,GAC/BwB,SAASC,QAAQ,UAAWzB,GAC5BJ,EAAK8B,KAAK5B,EAAOI,EAAQC,EAAOC,GAASU,KAAK,SAAUa,EAAMC,EAAYP,GACzEZ,EAASI,QAAQc,EAAMC,EAAYP,IACjC,SAAUA,EAAOO,EAAYC,GACX,KAAhBR,EAAMS,QAAiBT,EAAMS,QAAU,IAC1CD,EAAc,wDACa,MAAjBR,EAAMS,SAAmBT,EAAMU,cAAgBV,EAAMW,eAA8D,IAA9CX,EAAMW,aAAaC,QAAQ,gBAAsE,IAA9CZ,EAAMW,aAAaC,QAAQ,cAE7I,IAAZzB,EACHX,EAASqC,UAAU,CAClBC,SAAU,WACTtC,EAASuC,WAAWhC,GAASU,KAAK,WACjCb,EAAQyB,KAAK5B,EAAOI,EAAQC,EAAOC,EAASI,EAAU,IACpD,WACEX,EAAS0B,KACZ1B,EAASwC,YAIZnB,mBAAoBd,EAAQe,sBAG7BU,EAAc,iBAELR,EAAMU,cAAgBV,EAAMU,aAAaO,OAASjB,EAAMU,aAAaO,MAAMC,QACrFV,EAAcR,EAAMU,aAAaO,MAAMC,QAC7BlB,EAAMW,eAChBH,EAAcR,EAAMW,cAGrBvB,EAASW,OAAOC,EAAOO,EAAYC,KACjCW,OAAO,WACS,EAAdxC,EACHA,GAA4B,EAE5BA,EAAc,EAGfwB,SAASC,QAAQ,OAAQ,MAAOzB,GAChCwB,SAASC,QAAQ,WAAYzB,MAE5B,WACFS,EAASW,OAAO,KAAM,KAAM,oBAGtBX","file":"syncfactory.min.js","sourcesContent":["'use strict';\n\n/* exported syncFactory */\nfunction syncFactory(sync, cotLogin) {\n\tvar _this = this;\n\n\tvar syncCounter = 0;\n\tvar newSync = function newSync(method, model) {\n\t\tvar options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\t\tvar attempt = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 1;\n\n\t\tvar deferred = $.Deferred();\n\n\t\tPromise.resolve().then(function () {\n\t\t\tif (_.result(model, 'syncNeedsLogin')) {\n\t\t\t\tif (cotLogin) {\n\t\t\t\t\treturn cotLogin.requireLogin({\n\t\t\t\t\t\toriginatingElement: options.$originatingElement\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\treturn Promise.reject();\n\t\t\t\t}\n\t\t\t}\n\t\t}).then(function () {\n\t\t\tif (_.result(model, 'syncNeedsLogin')) {\n\t\t\t\toptions['beforeSend'] = function (jqXHR) {\n\t\t\t\t\tjqXHR.setRequestHeader('Authorization', 'AuthSession ' + cotLogin.sid);\n\t\t\t\t};\n\t\t\t}\n\n\t\t\toptions['contentType'] = options['contentType'] || 'application/json';\n\n\t\t\tsyncCounter = syncCounter + 1;\n\t\t\tBackbone.trigger('sync', 'on', syncCounter);\n\t\t\tBackbone.trigger('sync:on', syncCounter);\n\t\t\tsync.call(_this, method, model, options).then(function (data, textStatus, jqXHR) {\n\t\t\t\tdeferred.resolve(data, textStatus, jqXHR);\n\t\t\t}, function (jqXHR, textStatus, errorThrown) {\n\t\t\t\tif (jqXHR.status >= 500 && jqXHR.status <= 599) {\n\t\t\t\t\terrorThrown = 'Server side error. Please contact your administrator.';\n\t\t\t\t} else if (jqXHR.status === 400 && !jqXHR.responseJSON && jqXHR.responseText && jqXHR.responseText.indexOf('Session id') !== -1 && jqXHR.responseText.indexOf('is invalid') !== -1) {\n\n\t\t\t\t\tif (attempt === 1) {\n\t\t\t\t\t\tcotLogin.showLogin({\n\t\t\t\t\t\t\tonHidden: function onHidden() {\n\t\t\t\t\t\t\t\tcotLogin.checkLogin(options).then(function () {\n\t\t\t\t\t\t\t\t\tnewSync.call(_this, method, model, options, attempt + 1);\n\t\t\t\t\t\t\t\t}, function () {\n\t\t\t\t\t\t\t\t\tif (cotLogin.sid) {\n\t\t\t\t\t\t\t\t\t\tcotLogin.logout();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\toriginatingElement: options.$originatingElement\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\terrorThrown = 'Login Required';\n\t\t\t\t\t}\n\t\t\t\t} else if (jqXHR.responseJSON && jqXHR.responseJSON.error && jqXHR.responseJSON.error.message) {\n\t\t\t\t\terrorThrown = jqXHR.responseJSON.error.message;\n\t\t\t\t} else if (jqXHR.responseText) {\n\t\t\t\t\terrorThrown = jqXHR.responseText;\n\t\t\t\t}\n\n\t\t\t\tdeferred.reject(jqXHR, textStatus, errorThrown);\n\t\t\t}).always(function () {\n\t\t\t\tif (syncCounter > 0) {\n\t\t\t\t\tsyncCounter = syncCounter - 1;\n\t\t\t\t} else {\n\t\t\t\t\tsyncCounter = 0;\n\t\t\t\t}\n\n\t\t\t\tBackbone.trigger('sync', 'off', syncCounter);\n\t\t\t\tBackbone.trigger('sync:off', syncCounter);\n\t\t\t});\n\t\t}, function () {\n\t\t\tdeferred.reject(null, null, 'Login Required');\n\t\t});\n\n\t\treturn deferred;\n\t};\n\n\treturn newSync;\n}"]}